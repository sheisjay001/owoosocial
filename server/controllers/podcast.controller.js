const Podcast = require('../models/Podcast');
const podcastService = require('../services/podcast.service');

// In-memory store for fallback
let mockPodcasts = [];

exports.createPodcast = async (req, res) => {
  try {
    const { title, topic, scheduledTime, status, platforms } = req.body;
    let podcast;

    try {
      podcast = await Podcast.create({
        title,
        topic,
        scheduledTime,
        status: status || 'draft',
        platforms: platforms || ['spotify']
      });
    } catch (dbError) {
      console.log('DB Error, using in-memory store:', dbError.message);
      podcast = {
        _id: Date.now().toString(),
        title,
        topic,
        scheduledTime,
        status: status || 'draft',
        platforms: platforms || ['spotify'],
        createdAt: new Date()
      };
      mockPodcasts.push(podcast);
    }

    res.status(201).json({ success: true, data: podcast });
  } catch (error) {
    res.status(400).json({ success: false, error: error.message });
  }
};

exports.getPodcasts = async (req, res) => {
  try {
    let podcasts;
    try {
      podcasts = await Podcast.find().sort({ createdAt: -1 });
    } catch (dbError) {
      console.log('DB Error, using in-memory store:', dbError.message);
      podcasts = mockPodcasts.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
    }

    res.status(200).json({ success: true, count: podcasts.length, data: podcasts });
  } catch (error) {
    res.status(500).json({ success: false, error: error.message });
  }
};

exports.generateScript = async (req, res) => {
  try {
    const { id } = req.params;
    let podcast;

    try {
      podcast = await Podcast.findById(id);
    } catch (dbError) {
      podcast = mockPodcasts.find(p => p._id === id);
    }

    if (!podcast) return res.status(404).json({ success: false, error: 'Podcast not found' });

    // Mock AI Script Generation
    const script = `[INTRO MUSIC]\n\nHOST: Welcome back to the show! Today we're discussing ${podcast.topic}.\n\n(Generated by OWOO AI)\n\n[OUTRO]`;
    
    podcast.script = script;
    podcast.status = 'scripted';

    if (podcast.save) {
        await podcast.save();
    } else {
        const index = mockPodcasts.findIndex(p => p._id === id);
        if (index !== -1) mockPodcasts[index] = podcast;
    }

    res.status(200).json({ success: true, data: podcast });
  } catch (error) {
    res.status(500).json({ success: false, error: error.message });
  }
};

exports.getPodcastAnalytics = async (req, res) => {
  try {
    const { id } = req.params;
    let podcast;

    try {
      podcast = await Podcast.findById(id);
    } catch (dbError) {
      podcast = mockPodcasts.find(p => p._id === id);
    }

    if (!podcast) return res.status(404).json({ success: false, error: 'Podcast not found' });

    // Use service to fetch analytics
    const analytics = await podcastService.getAnalytics(id);

    res.status(200).json({ success: true, data: analytics });
  } catch (error) {
    res.status(500).json({ success: false, error: error.message });
  }
};
